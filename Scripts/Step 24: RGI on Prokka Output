#!/bin/bash
#SBATCH --job-name=RGI_ProkkaOutput
#SBATCH --output=RGI_ProkkaOutput.out
#SBATCH --error=RGI_ProkkaOutput.err
#SBATCH --time=48:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --partition=k2-lowpri

source /opt/apps/mamba/1.3.1/python3-3.10.5+gcc-9.3.0/mambaforge/etc/profile.d/conda.sh
conda activate rgi_blast_env

if [[ "$CONDA_DEFAULT_ENV" != "rgi_blast_env" ]]; then
    echo "Error: Conda environment 'rgi_blast_env' was not activated!"
    exit 1
fi

RGI_DB="/users/40296019/sharedscratch/rgi_database"
CARD_JSON="$RGI_DB/card.json"
INPUT_FA="pan_genome_reference_modified.fa"
OUTPUT_DIR="rgi_results"

mkdir -p "$OUTPUT_DIR"

if [[ ! -f "$CARD_JSON" ]]; then
    echo "Error: card.json not found in $RGI_DB. Extracting database..."
    tar -xvjf "$RGI_DB/card-data.tar.bz2" -C "$RGI_DB"
fi

echo "Loading RGI database..."
rgi load --local --card_json "$CARD_JSON"

echo "Running RGI on $INPUT_FA..."
rgi main \
    --input_sequence "$INPUT_FA" \
    --output_file "$OUTPUT_DIR/rgi_output" \
    --local \
    --num_threads 8

conda deactivate

echo "âœ… RGI analysis completed successfully!"
